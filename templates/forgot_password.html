{% extends "base.html" %}

{% block title %}Forgot Password - LearnVaultX{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>Reset Password</h1>
            <p>Enter your email to receive an OTP</p>
        </div>
        
        <!-- Step 1: Request OTP -->
        <div id="step-1" class="reset-step">
            <form id="request-otp-form" onsubmit="requestOTP(event)">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required placeholder="Enter your registered email">
                </div>
                
                <div class="error-message" id="error-message-1"></div>
                <div class="success-message" id="success-message-1"></div>
                
                <button type="submit" class="btn btn-primary btn-full">Send OTP</button>
            </form>
        </div>
        
        <!-- Step 2: Verify OTP and Reset Password -->
        <div id="step-2" class="reset-step" style="display: none;">
            <form id="reset-password-form" onsubmit="resetPassword(event)">
                <div class="form-group">
                    <label for="otp">Enter 4-Digit OTP</label>
                    <input type="text" id="otp" name="otp" required placeholder="Enter OTP" maxlength="4" pattern="[0-9]{4}">
                    <small>Check your email for the OTP (valid for 10 minutes)</small>
                </div>
                
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new-password" required placeholder="Enter new password" minlength="6">
                    <small>Must be at least 6 characters</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" name="confirm-password" required placeholder="Confirm new password">
                </div>
                
                <div class="error-message" id="error-message-2"></div>
                <div class="success-message" id="success-message-2"></div>
                
                <button type="submit" class="btn btn-primary btn-full">Reset Password</button>
                <button type="button" class="btn btn-secondary btn-full" onclick="goBackToStep1()">Back</button>
            </form>
        </div>
        
        <div class="auth-footer">
            <p>Remember your password? <a href="/login">Login here</a></p>
        </div>
    </div>
</div>

<style>
.reset-step {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.success-message {
    background-color: #d4edda;
    color: #155724;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    display: none;
    border: 1px solid #c3e6cb;
}

.forgot-password-link {
    text-align: right;
    margin-top: -10px;
    margin-bottom: 15px;
}

.forgot-password-link a {
    color: #667eea;
    font-size: 14px;
    text-decoration: none;
}

.forgot-password-link a:hover {
    text-decoration: underline;
}

small {
    color: #666;
    font-size: 12px;
}
</style>

<script>
let userEmail = '';

async function requestOTP(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const errorMsg = document.getElementById('error-message-1');
    const successMsg = document.getElementById('success-message-1');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';
    
    try {
        const response = await fetch('/api/forgot-password/send-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            userEmail = email;
            
            // Check if it's demo mode (OTP returned in response)
            if (data.demo_mode && data.otp) {
                successMsg.innerHTML = `
                    <strong>Demo Mode:</strong> ${data.message}<br>
                    <small style="color: #666;">Copy this OTP: <strong>${data.otp}</strong></small>
                `;
            } else {
                successMsg.textContent = data.message;
            }
            successMsg.style.display = 'block';
            
            // Move to step 2 after 2 seconds
            setTimeout(() => {
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
            }, 2000);
        } else {
            errorMsg.textContent = data.error || 'Failed to send OTP';
            errorMsg.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send OTP';
        }
    } catch (error) {
        errorMsg.textContent = 'Network error. Please try again.';
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send OTP';
    }
}

async function resetPassword(event) {
    event.preventDefault();
    
    const otp = document.getElementById('otp').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const errorMsg = document.getElementById('error-message-2');
    const successMsg = document.getElementById('success-message-2');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        errorMsg.textContent = 'Passwords do not match';
        errorMsg.style.display = 'block';
        return;
    }
    
    // Validate password length
    if (newPassword.length < 6) {
        errorMsg.textContent = 'Password must be at least 6 characters';
        errorMsg.style.display = 'block';
        return;
    }
    
    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Resetting...';
    
    try {
        const response = await fetch('/api/forgot-password/verify-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                email: userEmail,
                otp: otp,
                new_password: newPassword
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            successMsg.textContent = data.message + ' Redirecting to login...';
            successMsg.style.display = 'block';
            
            // Redirect to login after 2 seconds
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            errorMsg.textContent = data.error || 'Failed to reset password';
            errorMsg.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Reset Password';
        }
    } catch (error) {
        errorMsg.textContent = 'Network error. Please try again.';
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Reset Password';
    }
}

function goBackToStep1() {
    document.getElementById('step-2').style.display = 'none';
    document.getElementById('step-1').style.display = 'block';
    document.getElementById('request-otp-form').querySelector('button[type="submit"]').disabled = false;
    document.getElementById('request-otp-form').querySelector('button[type="submit"]').textContent = 'Send OTP';
}
</script>
{% endblock %}

