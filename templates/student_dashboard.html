{% extends "base.html" %}

{% block title %}Student Dashboard - LearnVaultX{% endblock %}

{% block content %}
<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- Feedback Button -->
<button class="feedback-btn" onclick="openFeedbackModal()" title="Give Feedback">‚òÖ</button>

<!-- Feedback Modal -->
<div id="feedback-modal" class="feedback-modal">
    <div class="feedback-modal-content">
        <div class="feedback-modal-header">
            <h2>Send Us Feedback</h2>
            <button class="close-feedback-btn" onclick="closeFeedbackModal()">√ó</button>
        </div>
        <form id="feedback-form">
            <div class="star-rating">
                <span class="star" onclick="selectRating(1)">‚òÖ</span>
                <span class="star" onclick="selectRating(2)">‚òÖ</span>
                <span class="star" onclick="selectRating(3)">‚òÖ</span>
                <span class="star" onclick="selectRating(4)">‚òÖ</span>
                <span class="star" onclick="selectRating(5)">‚òÖ</span>
            </div>
            <textarea id="feedback-message" class="feedback-textarea" placeholder="Tell us what you think... (optional)"></textarea>
            <button type="button" class="btn btn-primary btn-full" onclick="submitFeedback()">Submit Feedback</button>
        </form>
    </div>
</div>

<div class="dashboard">
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>LearnVaultX</h2>
            <p class="role-badge student">Student</p>
        </div>
        <ul class="nav-menu">
            <li class="active"><a href="#" onclick="showSection('my-classes')">My Classes</a></li>
            <li><a href="#" onclick="showSection('recommendations')">üìö AI Recommendations</a></li>
            <li><a href="#" onclick="showSection('knowledge-gaps')">üéØ Knowledge Gaps</a></li>
            <li><a href="#" onclick="showSection('available-classes')">Join Classes</a></li>
            <li><a href="#" onclick="showSection('progress')">My Progress</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
        <div class="user-info">
            <p>{{ session.name }}</p>
            <p class="text-muted">{{ session.email }}</p>
        </div>
    </nav>
    
    <main class="main-content">
        <!-- My Classes Section -->
        <section id="my-classes-section" class="dashboard-section">
            <div class="section-header">
                <h2>My Classes</h2>
            </div>
            
            <div id="my-classes-grid" class="cards-grid">
                <!-- Classes will be loaded here -->
            </div>
        </section>
        
        <!-- AI Recommendations Section -->
        <section id="recommendations-section" class="dashboard-section hidden">
            <div class="section-header">
                <h2>üìö Personalized Recommendations</h2>
                <p style="color: var(--text-muted); font-size: 14px;">AI-powered suggestions based on your learning gaps</p>
            </div>
            
            <div id="recommendations-container">
                <!-- Recommendations will be loaded here -->
            </div>
        </section>
        
        <!-- Knowledge Gaps Section -->
        <section id="knowledge-gaps-section" class="dashboard-section hidden">
            <div class="section-header">
                <h2>üéØ Knowledge Gaps Analysis</h2>
                <p style="color: var(--text-muted); font-size: 14px;">Topics where you need more practice</p>
            </div>
            
            <div id="knowledge-gaps-container">
                <!-- Knowledge gaps will be loaded here -->
            </div>
        </section>
        
        <!-- Available Classes Section -->
        <section id="available-classes-section" class="dashboard-section hidden">
            <div class="section-header">
                <h2>Available Classes</h2>
            </div>
            
            <div id="available-classes-grid" class="cards-grid">
                <!-- Available classes will be loaded here -->
            </div>
        </section>
        
        <!-- Progress Section -->
        <section id="progress-section" class="dashboard-section hidden">
            <div class="section-header">
                <h2>My Learning Progress</h2>
            </div>
            
            <div id="progress-container">
                <!-- Progress metrics will be loaded here -->
            </div>
        </section>
    </main>
</div>

<script>
async function loadMyClasses() {
    try {
        const response = await fetch('/api/student/classes');
        const classes = await response.json();
        
        const grid = document.getElementById('my-classes-grid');
        
        if (classes.length === 0) {
            grid.innerHTML = '<div class="empty-state"><p>You haven\'t joined any classes yet. Browse available classes to get started!</p></div>';
            return;
        }
        
        grid.innerHTML = classes.map(cls => `
            <div class="class-card">
                <h3>${cls.title}</h3>
                <p>${cls.description || 'No description'}</p>
                <p class="text-muted">Teacher: ${cls.teacher_name}</p>
                <div class="card-actions">
                    <a href="/class/${cls.id}" class="btn btn-primary btn-sm">Enter Class</a>
                    <button onclick="joinLiveClass(${cls.id})" class="btn btn-live btn-sm">Join Live Class</button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading classes:', error);
    }
}

async function loadAvailableClasses() {
    try {
        const response = await fetch('/api/available_classes');
        const classes = await response.json();
        
        const grid = document.getElementById('available-classes-grid');
        
        if (classes.length === 0) {
            grid.innerHTML = '<div class="empty-state"><p>No new classes available at the moment.</p></div>';
            return;
        }
        
        grid.innerHTML = classes.map(cls => `
            <div class="class-card">
                <h3>${cls.title}</h3>
                <p>${cls.description || 'No description'}</p>
                <p class="text-muted">Teacher: ${cls.teacher_name}</p>
                <div class="card-actions">
                    <button class="btn btn-primary btn-sm" onclick="joinClass(${cls.id})">Join Class</button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading available classes:', error);
    }
}

async function joinClass(classId) {
    try {
        const response = await fetch('/api/join_class', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ class_id: classId })
        });
        
        if (response.ok) {
            alert('Successfully joined the class!');
            loadAvailableClasses();
            loadMyClasses();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to join class');
        }
    } catch (error) {
        console.error('Error joining class:', error);
    }
}

async function loadProgress() {
    try {
        const response = await fetch('/api/analytics');
        const metrics = await response.json();
        
        const container = document.getElementById('progress-container');
        
        if (metrics.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No progress data yet. Take quizzes to see your progress!</p></div>';
            return;
        }
        
        container.innerHTML = `
            <div class="progress-cards">
                ${metrics.map(m => `
                    <div class="progress-card">
                        <h3>${m.class_name}</h3>
                        <div class="metric-grid">
                            <div class="metric">
                                <span class="metric-label">Average Score</span>
                                <span class="metric-value">${m.score_avg}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Avg Time</span>
                                <span class="metric-value">${m.avg_time}s</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Learning Pace</span>
                                <span class="metric-value ${m.pace_score < 4.5 ? 'low' : 'good'}">${m.pace_score}/10</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Overall Rating</span>
                                <span class="metric-value rating">${m.rating}/10</span>
                            </div>
                        </div>
                        ${m.pace_score < 4.5 ? `
                            <div class="recommendation">
                                <h4>Recommendations</h4>
                                <ul>
                                    <li>Review previous lectures</li>
                                    <li>Practice more quizzes</li>
                                    <li>Ask questions to the AI assistant</li>
                                    <li>Engage more in class discussions</li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Error loading progress:', error);
    }
}

async function loadRecommendations() {
    try {
        const response = await fetch('/api/recommendations');
        const data = await response.json();
        
        const container = document.getElementById('recommendations-container');
        
        const recommendations = data.recommendations || [];
        
        if (recommendations.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>‚ú® Great job! No urgent recommendations right now. Keep taking quizzes to get personalized suggestions!</p></div>';
            return;
        }
        
        container.innerHTML = `
            <div class="cards-grid">
                ${recommendations.map(rec => `
                    <div class="class-card" style="border-left: 4px solid ${rec.priority > 70 ? '#ef4444' : '#f59e0b'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <h3>${rec.content_type === 'lecture' ? 'üìÑ' : 'üìù'} ${rec.content_title || 'Recommended Content'}</h3>
                            <span class="badge ${rec.priority > 70 ? 'badge-warning' : 'badge-success'}">
                                Priority: ${rec.priority}
                            </span>
                        </div>
                        <p style="margin: 10px 0; color: var(--text-muted);">${rec.reason}</p>
                        <div class="card-actions">
                            ${rec.content_type === 'lecture' ? 
                                `<button class="btn btn-primary btn-sm" onclick="window.location.href='/class/${rec.content_id}'">View Lecture</button>` :
                                `<button class="btn btn-primary btn-sm" onclick="window.location.href='/class/${rec.content_id}'">Take Quiz</button>`
                            }
                            <button class="btn btn-secondary btn-sm" onclick="markRecommendationComplete(${rec.id})">Mark Complete</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Error loading recommendations:', error);
        document.getElementById('recommendations-container').innerHTML = 
            '<div class="empty-state"><p>Unable to load recommendations. Please try again later.</p></div>';
    }
}

async function markRecommendationComplete(recId) {
    try {
        await fetch(`/api/mark-recommendation-complete/${recId}`, { method: 'POST' });
        loadRecommendations();
    } catch (error) {
        console.error('Error marking complete:', error);
    }
}

async function loadKnowledgeGaps() {
    try {
        const response = await fetch('/api/knowledge-gaps');
        const gaps = await response.json();
        
        const container = document.getElementById('knowledge-gaps-container');
        
        if (gaps.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>üéâ Excellent! No significant knowledge gaps detected. You\'re doing great!</p></div>';
            return;
        }
        
        // Group by class
        const gapsByClass = {};
        gaps.forEach(gap => {
            if (!gapsByClass[gap.class_name]) {
                gapsByClass[gap.class_name] = [];
            }
            gapsByClass[gap.class_name].push(gap);
        });
        
        container.innerHTML = Object.entries(gapsByClass).map(([className, classGaps]) => `
            <div style="margin-bottom: 30px;">
                <h3 style="color: var(--accent); margin-bottom: 15px;">${className}</h3>
                <div class="cards-grid">
                    ${classGaps.map(gap => {
                        const masteryPct = (gap.mastery_level * 100).toFixed(1);
                        const severity = masteryPct < 40 ? 'critical' : 'moderate';
                        return `
                            <div class="progress-card" style="border-left: 4px solid ${severity === 'critical' ? '#ef4444' : '#f59e0b'};">
                                <h3>${gap.topic_name}</h3>
                                <div style="margin: 15px 0;">
                                    <div style="background: var(--surface-light); height: 24px; border-radius: 12px; overflow: hidden;">
                                        <div style="background: ${severity === 'critical' ? '#ef4444' : '#f59e0b'}; height: 100%; width: ${masteryPct}%; transition: width 0.3s;"></div>
                                    </div>
                                    <p style="margin-top: 8px; text-align: center; color: var(--text-muted);">
                                        Mastery: ${masteryPct}%
                                    </p>
                                </div>
                                <div class="metric-grid">
                                    <div class="metric">
                                        <span class="metric-label">Questions Attempted</span>
                                        <span class="metric-value">${gap.questions_attempted}</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">Correct</span>
                                        <span class="metric-value ${severity === 'critical' ? 'low' : ''}">${gap.questions_correct}</span>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                                    <strong style="color: var(--warning);">üí° Recommendation:</strong>
                                    <p style="margin-top: 5px; font-size: 13px; color: var(--text-muted);">
                                        ${severity === 'critical' ? 
                                            'Review lecture materials and practice more quizzes on this topic.' :
                                            'Take a few more practice quizzes to strengthen your understanding.'
                                        }
                                    </p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading knowledge gaps:', error);
        document.getElementById('knowledge-gaps-container').innerHTML = 
            '<div class="empty-state"><p>Unable to load knowledge gaps. Please try again later.</p></div>';
    }
}

function showSection(section) {
    document.querySelectorAll('.dashboard-section').forEach(s => s.classList.add('hidden'));
    document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
    
    const sections = {
        'my-classes': { index: 0, element: 'my-classes-section', load: loadMyClasses },
        'recommendations': { index: 1, element: 'recommendations-section', load: loadRecommendations },
        'knowledge-gaps': { index: 2, element: 'knowledge-gaps-section', load: loadKnowledgeGaps },
        'available-classes': { index: 3, element: 'available-classes-section', load: loadAvailableClasses },
        'progress': { index: 4, element: 'progress-section', load: loadProgress }
    };
    
    if (sections[section]) {
        document.getElementById(sections[section].element).classList.remove('hidden');
        document.querySelectorAll('.nav-menu li')[sections[section].index].classList.add('active');
        sections[section].load();
    }
}

// Load my classes on page load
loadMyClasses();
</script>
{% endblock %}

